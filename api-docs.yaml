openapi: 3.0.3
info:
  title: 醃造所專題 API
  version: 1.0.0
  description: |
    **Supabase 前端設定方式**：
      - supabaseUrl: `https://kficknhvujgeaooqxiif.supabase.co`<br><br>
      - supabaseAnonKey: `找俐涵拿`
tags:
- name: Auth
  description: 註冊與登入 API
- name: 產品資訊
- name: 會員資訊
- name: 優惠券
- name: 購物車
  description: 別用，還沒好！！！
- name: 首頁
  description: 顧客好評
servers:
  - url: https://kficknhvujgeaooqxiif.supabase.co/rest/v1

paths:
  # -------------------------
  # Auth API
  # -------------------------
  /auth/signup:
    post:
      tags:
        - Auth
      summary: 註冊新帳號（Email + Password）
      description: |
        使用者輸入 Email 與密碼即可註冊。
        註冊後會自動在 profiles table 建立對應資料。
        **前端範例（Supabase JS）**：
        ```javascript
        import { createClient } from '@supabase/supabase-js'
        const supabase = createClient('https://kficknhvujgeaooqxiif.supabase.co', '你的 anon key')
        const { data, error } = await supabase.auth.signUp({ email: 'user@example.com', password: 'yourPassword123' })
        ```
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string, example: "user@example.com" }
                password: { type: string, example: "yourPassword123" }
      responses:
        '200':
          description: 註冊成功，回傳使用者資訊
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /auth/signin:
    post:
      tags:
        - Auth
      summary: 使用 Email + Password 登入
      description: |
        登入成功後會回傳 JWT，可用於呼叫其他受保護 API。
        **前端範例（Supabase JS）**：
        ```javascript
        const { data, error } = await supabase.auth.signInWithPassword({ email: 'user@example.com', password: 'yourPassword123' })
        ```
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string, example: "user@example.com" }
                password: { type: string, example: "yourPassword123" }
      responses:
        '200':
          description: 登入成功，回傳 session 與使用者資訊
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  # -------------------------
  # 產品 API
  # -------------------------
  /products:
    get:
      tags:
        - 產品資訊
      summary: 取得所有商品（含變體）
      responses:
        '200':
          description: 商品列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Product'

  /products/{id}:
    get:
      tags:
        - 產品資訊
      summary: 取得單一商品（含變體）
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: 單一商品
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'

  # -------------------------
  # 購物車 API
  # -------------------------
  /carts:
    get:
      tags:
        - 購物車
      summary: 取得使用者購物車
      parameters:
        - in: query
          name: user_id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: 購物車列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CartItem'
    post:
      tags:
        - 購物車
      summary: 新增購物車項目
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CartItemInput'
      responses:
        '201':
          description: 新增成功
    delete:
      tags:
        - 購物車
      summary: 清空購物車
      parameters:
        - in: query
          name: user_id
          required: true
          schema: { type: string }
      responses:
        '204':
          description: 已清空

  # -------------------------
  # 優惠券 API
  # -------------------------
  /coupons:
    get:
      tags:
        - 優惠券
      summary: 取得可用優惠券
      responses:
        '200':
          description: 優惠券列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Coupon'
    post:
      tags:
        - 優惠券
      summary: 套用優惠券
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                user_id: { type: string }
                coupon_code: { type: string }
      responses:
        '200':
          description: 回傳折扣金額
          content:
            application/json:
              schema:
                type: object
                properties:
                  discount_amount: { type: integer }

  # -------------------------
  # 顧客評論 API
  # -------------------------
  /customer_reviews:
    get:
      tags:
        - 首頁
      summary: 取得顧客評論
      responses:
        '200':
          description: 顧客評論列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CustomerReview'

  # -------------------------
  # 會員資訊 API
  # -------------------------
  /users/{id}:
    get:
      tags:
        - 會員資訊
      summary: 取得使用者資訊
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: 使用者資訊
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

    patch:
      tags:
        - 會員資訊
      summary: 更新使用者資料（可部分更新）
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserInput'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

components:
  schemas:
    AuthResponse:
      type: object
      properties:
        user:
          $ref: '#/components/schemas/User'
        session:
          type: object
          properties:
            access_token: { type: string }
            refresh_token: { type: string }
            expires_in: { type: integer }

    User:
      type: object
      properties:
        id: { type: string }
        email: { type: string }
        full_name: { type: string }
        phone: { type: string }
        address: { type: string }
        title: { type: string }
        birthday: { type: string, format: date }

    UserInput:
      type: object
      properties:
        email: { type: string, nullable: true }
        full_name: { type: string, nullable: true }
        phone: { type: string, nullable: true }
        address: { type: string, nullable: true }
        title: { type: string, nullable: true }
        birthday: { type: string, format: date }

    Product:
      type: object
      properties:
        id: { type: string }
        title: { type: string }
        category: { type: string }
        description: { type: string }
        image_url: { type: string }
        images_url:
          type: array
          items: { type: string }
        origin:
          type: object
          additionalProperties: { type: string }
        price: { type: integer }
        num: { type: integer }
        summary: { type: string }
        ingredients: { type: string }
        variants:
          type: array
          items:
            $ref: '#/components/schemas/Variant'

    Variant:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        price: { type: integer }
        stock: { type: integer }

    CartItem:
      type: object
      properties:
        cart_id: { type: string }
        user_id: { type: string }
        product: { $ref: '#/components/schemas/Product' }
        variant: { $ref: '#/components/schemas/Variant' }
        quantity: { type: integer }
        subtotal: { type: integer }

    CartItemInput:
      type: object
      properties:
        user_id: { type: string }
        product_id: { type: string }
        variant_id: { type: string }
        quantity: { type: integer }

    Coupon:
      type: object
      properties:
        id: { type: string }
        code: { type: string }
        title: { type: string }
        description: { type: string }
        discount_amount: { type: integer }
        min_purchase: { type: integer }
        start_date: { type: string, format: date }
        end_date: { type: string, format: date }
        is_active: { type: boolean }

    CustomerReview:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        occupation: { type: string }
        photo_url: { type: string }
        comment: { type: string }
